{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Tables - RFID</title>

    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

    <!-- Your CSS -->
    <link href="{% static 'css/styles.css' %}" rel="stylesheet" />
    <link href="{% static 'css/custom-style.css' %}" rel="stylesheet" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
</head>
<body class="sb-nav-fixed">

<!-- Navbar / sidebar (твоя разметка) -->

<div class="container mt-4">
    <!-- Django messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Payments</h3>
        <button class="btn btn-primary" id="openManualBtn" data-toggle="modal" data-target="#exampleModal">New</button>
    </div>

    <!-- Table -->
    <table class="table table-striped">
        <thead>
            <tr><th>Client</th><th>RF ID</th><th>Balance</th><th>Created</th></tr>
        </thead>
        <tbody>
            {% for payment in payments %}
            <tr>
                <td>{{ payment.client.first_name }} {{ payment.client.last_name }}</td>
                <td>{{ payment.client.rf_id }}</td>
                <td>{{ payment.balance }}</td>
                <td>{{ payment.created_at|date:"d.m.Y H:i" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center text-muted">No payments</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><span id="modalTitle">New Payment</span></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <form id="rfidForm" method="POST" action="{% url 'tables' %}">
        {% csrf_token %}
        <div class="modal-body">
            <div class="form-group">
                <label for="cardUID">Card UID</label>
                <input type="text" id="cardUID" name="cardUID" class="form-control" placeholder="Scanned Card UID" readonly>
            </div>
            <div class="form-group">
                <label for="balance">Balance</label>
                <input type="number" step="0.01" id="balance" name="balance" class="form-control" placeholder="Enter balance">
            </div>
            <div id="scannerStatus" class="small text-muted">Scanner: waiting...</div>
        </div>

        <div class="modal-footer">
            <button type="submit" class="btn btn-primary" id="saveButton">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- jQuery, Popper, Bootstrap 4 JS -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"></script>

<script>
/*
  Django-based RFID listener
  - Использует endpoint /api/uid/ для получения последнего считанного UID
  - Автооткрытие модалки при скане новой карты
*/

(function() {
    const API_URL = '/api/uid/';
    const POLL_INTERVAL_MS = 800;
    const DUPLICATE_IGNORE_MS = 5000;

    let lastSeenUID = null;
    let lastSeenAt = 0;
    let modalOpen = false;

    function setStatus(text) {
        const el = document.getElementById('scannerStatus');
        if (el) el.textContent = 'Scanner: ' + text;
    }

    async function pollOnce() {
        try {
            const resp = await fetch(API_URL);
            if (!resp.ok) {
                console.warn('UID API returned', resp.status);
                setStatus('API response ' + resp.status);
                return;
            }
            const data = await resp.json();
            const uid = data.uid ? String(data.uid).trim().toUpperCase() : null;

            if (!uid) {
                setStatus('no card');
                return;
            }

            const now = Date.now();
            if (uid === lastSeenUID && (now - lastSeenAt) < DUPLICATE_IGNORE_MS) {
                setStatus(uid + ' (seen)');
                return;
            }

            lastSeenUID = uid;
            lastSeenAt = now;
            setStatus(uid);

            const input = document.getElementById('cardUID');
            if (input) input.value = uid;

            if (!modalOpen) {
                $('#exampleModal').modal('show');
            }
        } catch (err) {
            console.error('Error fetching UID:', err);
            setStatus('error');
        }
    }

    function startPolling() {
        setInterval(pollOnce, POLL_INTERVAL_MS);
        setStatus('listening...');
    }

    $('#exampleModal').on('show.bs.modal', function () {
        modalOpen = true;
        document.getElementById('balance').value = '';
        setTimeout(() => { document.getElementById('balance').focus(); }, 300);
    });

    $('#exampleModal').on('hidden.bs.modal', function () {
        modalOpen = false;
    });

    document.addEventListener('DOMContentLoaded', startPolling);
})();
</script>

</body>
</html>
